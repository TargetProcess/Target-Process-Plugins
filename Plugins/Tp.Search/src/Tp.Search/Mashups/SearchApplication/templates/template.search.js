tau.mashups
    .addDependency('tau/core/templates-factory')
    .addDependency('tp/search/templates/template.search.fn')
    .addModule('tp/search/templates/template.search', function(templatesFactory, fn) {
        var config = {
            name:   'search',
            engine: 'jqote2',
            customFunctions: fn,
            markup: [
                '<% if (this.error) { %>',
                '    <div class="tau-search-result__list">',
                '        <div class="tau-search-result__item tau-search-result__item--error">',
                '            <div class="tau-search-result__content">',
                '                <div class="tau-body"><%= this.response.responseText %></div>',
                '            </div>',
                '        </div>',
                '        <div class="tau-search-result__item">',
                '            <div class="tau-search-result__content">',
                '                <div class="tau-body">',
                '                    <%= fn.intl.formatMessage("Something is wrong with the search. Try again.") %>',
                '                </div>',
                '            </div>',
                '        </div>',
                '    </div>',
                '<% } else { %>',
                '    <div class="tau-search-result__list">',
                '        <% if (this.info.indexProgress < 100) { %>',
                '            <div class="tau-search-result__item tau-search-result__item--notification">',
                '                <div class="tau-search-result__content">',
                '                    <div class="tau-body">',
                '                        <%= fn.intl.formatMessage("Search results might be incomplete at this point. Indexing is still in progressâ€¦") %>',
                '                    </div>',
                '                </div>',
                '            </div>',
                '        <% } %>',
                '        <% var keywords = this.keywords; %>',
                '        <% if (this.items.length === 0) { %>',
                '            <div class="tau-search-result__item">',
                '                <div class="tau-search-result__content">',
                '                    <div class="tau-body">',
                '                        <%= fn.intl.formatMessage("Nothing found") %>',
                '                    </div>',
                '                </div>',
                '            </div>',
                '        <% } else { %>',
                '            <% _.forEach(this.items, function(d) { %>',
                '                <% var entityType = d.entityType.name.toLowerCase(); %>',
                '                <% var isComment = (entityType === "comment"); %>',
                '                <% var isTestStep = (entityType === "teststep"); %>',
                '                <div class="tau-search-result__item i-role-search-result-item" data-entity-id="<%= d.id %>">',
                '                    <div class="tau-search-result__content">',
                '                        <div class="tau-header">',
                '                            <span class="tau-search-result__entity-icon">',
                '                               <span class="tau-entity-icon tau-entity-icon--<%= entityType %>">',
                '                                   <%! d.entityType.term %>',
                '                               </span>',
                '                            </span>',
                '                            <% if (isComment) { %>',
                '                                <span class="tau-search-result__entity-icon">',
                '                                   <span class="tau-entity-icon tau-entity-icon--<%= d.general.entityType.name.toLowerCase() %>">',
                '                                       <%! d.general.entityType.term %>',
                '                                   </span>',
                '                                </span>',
                '                                <a href="<%= d.url %>" class="tau-entity-id">',
                '                                    #<%= d.general.id %>',
                '                                </a>',
                '                            <% } else if (isTestStep) { %>',
                '                                <span class="tau-search-result__entity-icon">',
                '                                   <span class="tau-entity-icon tau-entity-icon--<%= d.testCase.entityType.name.toLowerCase() %>">',
                '                                       <%! d.testCase.entityType.term %>',
                '                                   </span>',
                '                                </span>',
                '                                <a href="<%= d.url %>" class="tau-entity-id">#<%= d.testCase.id %></a>',
                '                            <% } else { %>',
                '                                <a href="<%= d.url %>" class="tau-entity-id">#<%= d.id %></a>',
                '                                <span class="tau-entity-filter">',
                '                                    <%= fn.format(d.tags.join(" "), keywords, false) %>',
                '                                </span>',
                '                            <% } %>',
                '                        </div>',
                '                        <div class="tau-body">',
                '                            <% if (isComment) { %>',
                '                                <h3><a href="<%= d.url %>"><%! d.general.name %></a></h3>',
                '                                <p><%= fn.format(d.descExt, keywords, true) %></p>',
                '                            <% } else if (isTestStep) { %>',
                '                                <h3><a href="<%= d.url %>"><%! d.testCase.name %></a></h3>',
                '                                <div class="tau-teststep">',
                '                                    <span class="tau-teststep__runorder"><%= d.runOrder %></span>',
                '                                    <p><%= fn.format(d.description, keywords, true) %></p>',
                '                                    <p><%= fn.format(d.result, keywords, true) %></p>',
                '                                </div>',
                '                            <% } else { %>',
                '                                <h3><a href="<%= d.url %>"><%= fn.format(_.escape(d.nameExt), keywords, false) %></a></h3>',
                '                                <p><%= fn.format(d.descExt, keywords, true) %></p>',
                '                            <% } %>',
                '                        </div>',
                '                    </div>',
                '                    <div class="tau-search-result__info">',
                '                        <% if (d.entityState) { %>',
                '                            <div class="tau-search-result__info__row<% if (d.entityState.isFinal) { %> tau-search-result__info__row--done-entity<% } %>">',
                '                                <div class="tau-search-result__info__caption">',
                '                                    <%= fn.intl.formatMessage("State") %>',
                '                                </div>',
                '                                <div class="tau-search-result__info__txt"><%! d.entityState.name %></div>',
                '                            </div>',
                '                        <% } %>',
                '                        <% if (d.createDate) { %>',
                '                            <div class="tau-search-result__info__row">',
                '                                <div class="tau-search-result__info__caption">',
                '                                    <%= fn.intl.formatMessage("Created") %>',
                '                                </div>',
                '                                <div class="tau-search-result__info__txt"><%= fn.formatDate(d.createDate) %></div>',
                '                            </div>',
                '                        <% } %>',
                '                        <% if (d.project) { %>',
                '                            <div class="tau-search-result__info__row">',
                '                                <div class="tau-search-result__info__caption">',
                '                                    <%= fn.intl.formatMessage("Project") %>',
                '                                </div>',
                '                                <div class="tau-search-result__info__txt"><%! d.project.name %></div>',
                '                            </div>',
                '                        <% } %>',
                '                        <% if (!_.isEmpty(d.assignedTeams)) { %>',
                '                            <div class="tau-search-result__info__row">',
                '                                <div class="tau-search-result__info__caption">',
                '                                    <% if (this.featuresService.isEnabled("multiple.teams") && d.assignedTeams.length > 1) { %>',
                '                                        <%= fn.intl.formatMessage("Teams") %>',
                '                                    <% } else { %>',
                '                                        <%= fn.intl.formatMessage("Team") %>',
                '                                    <% } %>',
                '                                </div>',
                '                                <div class="tau-search-result__info__txt">',
                '                                    <% _.each(d.assignedTeams, function(teamAssignment) { %>',
                '                                        <span class="tau-search-result__info__txt__assigned-team i-role-search-result-assigned-team">',
                '                                            <%= fn.renderTeamIconWithFallback({name: teamAssignment.team.icon, fallbackName: "threeheads"}) %>',
                '                                            <%! teamAssignment.team.name %>',
                '                                        </span>',
                '                                    <% }); %>',
                '                                </div>',
                '                            </div>',
                '                        <% } %>',
                '                    </div>',
                '                </div>',
                '            <% }, this); %>',
                '            <% var pagesCount = Math.ceil(this.info.total / this.info.pageSize); %>',
                '            <% if (pagesCount > 1) { %>',
                '               <div class="tau-search-result__paging">',
                '                <div class="tau-paging i-role-paging-container">',
                '                    <div class="tau-paging__links">',
                '                        <a href="" class="tau-paging__prev<% if (this.info.pageNo == 0) { %> disabled<% } %> i-role-paging-prev">',
                '                            <%= fn.intl.formatMessage("Previous") + " " + this.info.pageSize %>',
                '                        </a>',
                '                        <a href="" class="tau-paging__next<% if (this.info.pageNo == (pagesCount - 1)) { %> disabled<% } %> i-role-paging-next">',
                '                            <%= fn.intl.formatMessage("Next") + " " + this.info.pageSize %>',
                '                        </a>',
                '                    </div>',
                '                    <div class="tau-paging__list i-role-paging-pageno">',
                '                        <% var pagingItems = fn.generatePagingItems(this.info.pageNo, pagesCount, 5); %>',
                '                        <% for (var i = 0; i < pagingItems.length; i++) { %>',
                '                            <% var item = pagingItems[i]; %>',
                '                            <% if (item.index == this.info.pageNo) { %>',
                '                                <span class="tau-paging__item active"><%= item.text %></span>',
                '                            <% } else { %>',
                '                                <a class="tau-paging__item" href="" data-page="<%= item.index %>">',
                '                                    <%= item.text %>',
                '                                </a>',
                '                            <% } %>',
                '                        <% } %>',
                '                    </div>',
                '                </div>',
                '            </div>',
                '            <% } %>',
                '        <% } %>',
                '    </div>',
                '<% } %>'
            ]
        };

        return templatesFactory.register(config);
    });
